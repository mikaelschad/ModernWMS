using Microsoft.Data.SqlClient;using ModernWMS.Backend.Models;using System.Data;namespace ModernWMS.Backend.Repositories;public class SqlConsigneeRepository:IConsigneeRepository{private readonly string _conn;public SqlConsigneeRepository(IConfiguration cfg){_conn=cfg.GetConnectionString("LegacySqlDB")??throw new InvalidOperationException();}public async Task<IEnumerable<Consignee>>GetAllAsync(){var lst=new List<Consignee>();using var c=new SqlConnection(_conn);await c.OpenAsync();using var cmd=new SqlCommand("SELECT*FROM CONSIGNEE ORDER BY NAME",c);using var r=await cmd.ExecuteReaderAsync();while(await r.ReadAsync())lst.Add(Map(r));return lst;}public async Task<Consignee?>GetByIdAsync(string id){using var c=new SqlConnection(_conn);await c.OpenAsync();using var cmd=new SqlCommand("SELECT*FROM CONSIGNEE WHERE CONSIGNEEID=@id",c);cmd.Parameters.AddWithValue("@id",id);using var r=await cmd.ExecuteReaderAsync();if(await r.ReadAsync())return Map(r);return null;}public async Task<string>CreateAsync(Consignee con){using var c=new SqlConnection(_conn);await c.OpenAsync();using var cmd=new SqlCommand("INSERT INTO CONSIGNEE(CONSIGNEEID,NAME,ADDR1,ADDR2,CITY,STATE,POSTALCODE,COUNTRY,PHONE,EMAIL,LASTUPDATE,LASTUSER)VALUES(@id,@nm,@a1,@a2,@city,@st,@zip,@cntry,@ph,@em,GETDATE(),@usr)",c);cmd.Parameters.AddWithValue("@id",con.Id);cmd.Parameters.AddWithValue("@nm",con.Name);cmd.Parameters.AddWithValue("@a1",(object?)con.Address1??DBNull.Value);cmd.Parameters.AddWithValue("@a2",(object?)con.Address2??DBNull.Value);cmd.Parameters.AddWithValue("@city",(object?)con.City??DBNull.Value);cmd.Parameters.AddWithValue("@st",(object?)con.State??DBNull.Value);cmd.Parameters.AddWithValue("@zip",(object?)con.PostalCode??DBNull.Value);cmd.Parameters.AddWithValue("@cntry",(object?)con.Country??DBNull.Value);cmd.Parameters.AddWithValue("@ph",(object?)con.Phone??DBNull.Value);cmd.Parameters.AddWithValue("@em",(object?)con.Email??DBNull.Value);cmd.Parameters.AddWithValue("@usr","SYSTEM");await cmd.ExecuteNonQueryAsync();return con.Id;}public async Task<bool>UpdateAsync(Consignee con){using var c=new SqlConnection(_conn);await c.OpenAsync();using var cmd=new SqlCommand("UPDATE CONSIGNEE SET NAME=@nm,ADDR1=@a1,ADDR2=@a2,CITY=@city,STATE=@st,POSTALCODE=@zip,COUNTRY=@cntry,PHONE=@ph,EMAIL=@em,LASTUPDATE=GETDATE(),LASTUSER=@usr WHERE CONSIGNEEID=@id",c);cmd.Parameters.AddWithValue("@id",con.Id);cmd.Parameters.AddWithValue("@nm",con.Name);cmd.Parameters.AddWithValue("@a1",(object?)con.Address1??DBNull.Value);cmd.Parameters.AddWithValue("@a2",(object?)con.Address2??DBNull.Value);cmd.Parameters.AddWithValue("@city",(object?)con.City??DBNull.Value);cmd.Parameters.AddWithValue("@st",(object?)con.State??DBNull.Value);cmd.Parameters.AddWithValue("@zip",(object?)con.PostalCode??DBNull.Value);cmd.Parameters.AddWithValue("@cntry",(object?)con.Country??DBNull.Value);cmd.Parameters.AddWithValue("@ph",(object?)con.Phone??DBNull.Value);cmd.Parameters.AddWithValue("@em",(object?)con.Email??DBNull.Value);cmd.Parameters.AddWithValue("@usr","SYSTEM");return await cmd.ExecuteNonQueryAsync()>0;}public async Task<bool>DeleteAsync(string id){using var c=new SqlConnection(_conn);await c.OpenAsync();using var cmd=new SqlCommand("DELETE FROM CONSIGNEE WHERE CONSIGNEEID=@id",c);cmd.Parameters.AddWithValue("@id",id);return await cmd.ExecuteNonQueryAsync()>0;}private Consignee Map(IDataRecord r)=>new Consignee{Id=r["CONSIGNEEID"]?.ToString()??"",Name=r["NAME"]?.ToString()??"",Address1=r["ADDR1"]?.ToString(),Address2=r["ADDR2"]?.ToString(),City=r["CITY"]?.ToString(),State=r["STATE"]?.ToString(),PostalCode=r["POSTALCODE"]?.ToString(),Country=r["COUNTRY"]?.ToString(),Phone=r["PHONE"]?.ToString(),Email=r["EMAIL"]?.ToString(),LastUpdate=r["LASTUPDATE"]!=DBNull.Value?Convert.ToDateTime(r["LASTUPDATE"]):DateTime.Now,LastUser=r["LASTUSER"]?.ToString()??"SYSTEM"};}
